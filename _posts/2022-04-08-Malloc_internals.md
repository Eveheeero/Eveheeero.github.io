---
layout: post
title: Malloc 함수의 동작
---

> 개요
>
> MallocInternals 번역
>
> 

# 개요
 본 글은 [1]의 번역을 통해 malloc 함수의 동작을 살펴본다.
 
# MallocInternals 번역
## Malloc의 개요
 GNU C Library (glibc의) 의 malloc 라이브러리는 어플리케이션의 주소 공간에
할당된 메모리를 관리하는 다양한 함수들을 포함한다. Glibc malloc은
ptmalloc (pthreads malloc) 으로부터 파생되었고, ptmalloc은
dlmalloc (Doug Lea malloc) 으로부터 파생되었다. 이 malloc은 "힙 (heap)"
스타일을 따르고, 그것은 큰 영역의 메모리에 다양한 크기의 청크 (chunks) 가
존재한다는 것을 의미한다. 그리고 이는 예를 들자면, 비트맵과 배열 또는 동일한
크기의 블록 등을 사용하는 구현과 반대이다. 과거에는, 한 어플리케이션마다 하나의
힙만 할당되었지만, glibc의 malloc은 한 어플리케이션에 다수의 힙들이 할당되는
것을 허용한다. 이때 할당된 각각의 힙은 그 주소 공간 내부에서 자라게 된다.

 그럼, 이 문서에서 사용되는 몇 가지 용어를 정의해보자.
* Arena: 하나 또는 그 이상의 스레드가 공유하는, 하나 또는 그 이상의 힙 또는
힙 내부에서 "free"된 청크들의 링크드 리스트를 참조하는 구조체이다. 각 아레나에
연결된 스레드들은 그 아레나의 free 리스트로부터 메모리를 할당받을 것이다.
* Heap: 할당될 청크들로 나누어진 연속적인 영역의 메모리이다. 각 힙은 정확히
하나의 아레나에 속한다.
* Chunk: 할당될 수 있는(어플리케이션이 소유하는) 작은 범위의 메모리로, free될
수 있고 (이때는 glibc가 소유한다), 인접한 청크들과 결합되어 더 큰 범위를 가질
수 있다. 청크는 어플리케이션에게 할당되는 메모리의 블록을 둘러싸는 랩퍼 (wrapper)
라는 것을 기억하자. 각 청크는 하나의 힙에 존재하고 하나의 아레나에 속한다.
* Memory: 일반적으로 램 또는 스왑에 의해 얻어지는 어플리케이션 주소 공간의
비율을 말한다.

 본 문서에서 "메모리 (memory)"라는 용어를 오직 일반적인 용법으로만 사용할
것이다. 한편 glibc malloc 코드에는 리눅스 커널 (또는 다른 OS) 과 작업하는
코드가 있다. 그 코드는 커널에게 어떤 메모리가 매핑되어야 하는지와 어떤 메모리가
커널에게 리턴될 수 있는지에 대한 힌트를 주기 위한 것이다. 이때 "실제 메모리
(real memory)"와 "가상 메모리 (virtual memory)"의 구분은 명시되지 않는
한, 여기서 논하고자 하는 것과 관련이 없다.

## Chunk는 무엇인가?
 Glibc의 malloc은 chunk-oriented이다. 이는 큰 영역의 메모리 ("힙") 를
다양한 크기의 청크로 나눈다. 각 청크는 자신의 크기 (청크 헤더의 size 필드로)
와 인접한 청크들을 메타 데이터로 포함한다. 청크가 어플리케이션에 의해 사용될
때, "저장되는 데이터"는 청크의 크기뿐이다. 청크가 free되면, 어플리케이션의
데이터로 사용되던 부분은 아레나와 관련된 데이터로 채워지도록 재지정된다.
여기서 아레나와 관련된 데이터는 적합한 청크가 빠르게 검색되고, 필요하다면
재사용될 수 있도록, 링크드 리스트에서 사용되는 포인터와 같은 것이다. 또한,
free된 청크의 마지막 워드는 청크 크기가 복사된 것이다 (이때 LSB로부터
세 비트들을 0으로 둘 수도 있고, 플래그로 사용할 수도 있다).

 

# References
[1] CarlosODonell et al., MallocInternals,
https://sourceware.org/glibc/wiki/MallocInternals, 2022
